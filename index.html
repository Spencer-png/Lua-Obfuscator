<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Lua 5.1 Obfuscator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        /* Base dark theme for the body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* Fallback for a solid black background */
            background-image: linear-gradient(135deg, #020617 0%, #0f172a 100%); /* Dark gradient */
            min-height: 100vh;
            color: #e2e8f0; /* Light gray text for better readability */
        }

        .font-fira {
            font-family: 'Fira Code', monospace;
        }

        .cyber-grid {
            background-image:
                linear-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.1) 1px, transparent 1px);
            background-size: 25px 25px;
        }

        .glitch {
            position: relative;
            font-size: 3.5rem;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            animation: glitch-skew 2s infinite linear alternate-reverse;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .glitch::before,
        .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #020617;
            overflow: hidden;
        }

        .glitch::before {
            left: 2px;
            text-shadow: -2px 0 #3b82f6; 
            animation: glitch-anim-1 3s infinite linear alternate-reverse;
        }

        .glitch::after {
            left: -2px;
            text-shadow: -2px 0 #1d4ed8, 2px 2px #991b1b;
            animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim-1 { 0%{clip-path:inset(20% 0 75% 0)} 20%{clip-path:inset(65% 0 20% 0)} 40%{clip-path:inset(40% 0 40% 0)} 60%{clip-path:inset(80% 0 10% 0)} 80%{clip-path:inset(15% 0 70% 0)} 100%{clip-path:inset(50% 0 35% 0)} }
        @keyframes glitch-anim-2 { 0%{clip-path:inset(85% 0 5% 0)} 20%{clip-path:inset(25% 0 60% 0)} 40%{clip-path:inset(70% 0 25% 0)} 60%{clip-path:inset(10% 0 80% 0)} 80%{clip-path:inset(60% 0 30% 0)} 100%{clip-path:inset(30% 0 65% 0)} }
        @keyframes glitch-skew { 0%{transform:skew(0deg)} 25%{transform:skew(.5deg)} 50%{transform:skew(0deg)} 75%{transform:skew(-.5deg)} 100%{transform:skew(0deg)} }

        .code-input {
            background-color: rgba(15, 23, 42, 0.7); 
            border-color: #1e293b; 
            backdrop-filter: blur(8px);
        }
        .code-input:focus {
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.4), inset 0 0 15px rgba(59, 130, 246, 0.1);
            border-color: #3b82f6; 
        }

        /* Main action button */
        .btn-obfuscate {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            position: relative;
            overflow: hidden;
        }

        .btn-obfuscate::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-obfuscate:hover::before { left: 100%; }

        .btn-obfuscate:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3), 0 0 20px rgba(59, 130, 246, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-obfuscate:active { transform: translateY(-1px) scale(1.02); }

        .processing { animation: pulse 1.5s infinite; }

        .feature-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="cyber-grid" style="background-color: #020617;">

    <div class="min-h-screen flex flex-col items-center justify-center p-6">
        <header class="text-center mb-12">
            <h1 class="glitch mb-4" data-text="LUA 5.1 FORGE">LUA 5.1 FORGE</h1>
            <p class="text-gray-300 text-lg max-w-3xl leading-relaxed">
                Advanced polymorphic obfuscation engine with multi-layer VM architecture,
                dynamic bytecode transformation, and Lua 5.1 compatibility enforcement.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto mt-8">
                <div class="feature-card p-4 rounded-lg">
                    <h3 class="text-blue-400 font-bold mb-2">üîÑ Polymorphic VM</h3>
                    <p class="text-sm text-gray-400">Dynamic instruction morphing with runtime code generation</p>
                </div>
                <div class="feature-card p-4 rounded-lg">
                    <h3 class="text-blue-400 font-bold mb-2">üõ°Ô∏è Anti-Analysis</h3>
                    <p class="text-sm text-gray-400">Multi-layer detection and self-modification systems</p>
                </div>
                <div class="feature-card p-4 rounded-lg">
                    <h3 class="text-blue-400 font-bold mb-2">‚ö° Lua 5.1 Native</h3>
                    <p class="text-sm text-gray-400">Optimized for Lua 5.1 with backward compatibility</p>
                </div>
            </div>
        </header>

        <main class="w-full max-w-7xl flex flex-col lg:flex-row gap-8">
            <div class="flex-1">
                <div class="flex justify-between items-center mb-3">
                    <label for="lua-input" class="text-sm font-medium text-blue-300">Source Code (Lua 5.1)</label>
                    <div class="flex gap-2">
                        <button id="format-btn" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-lg transition-colors">
                            Format
                        </button>
                        <button id="validate-btn" class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-lg transition-colors">
                            Validate
                        </button>
                    </div>
                </div>
                <textarea id="lua-input" rows="20" class="code-input font-fira w-full p-4 border-2 rounded-xl text-gray-200 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="-- Enter your Lua 5.1 code here..."></textarea>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-center mb-3">
                    <label for="lua-output" class="text-sm font-medium text-blue-300">Obfuscated Output</label>
                    <div class="flex gap-2">
                        <button id="copy-btn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg transition-colors">
                            Copy
                        </button>
                        <button id="analyze-btn" class="text-xs bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded-lg transition-colors">
                            Analyze
                        </button>
                    </div>
                </div>
                <div class="relative">
                    <textarea id="lua-output" rows="20" readonly class="code-input font-fira w-full p-4 border-2 rounded-xl text-gray-300 transition-all duration-300" placeholder="Obfuscated code will appear here..."></textarea>
                    <div id="output-stats" class="absolute bottom-3 left-3 text-xs text-gray-500"></div>
                </div>
            </div>
        </main>

        <footer class="mt-10 text-center">
            <div class="mb-6">
                <label class="text-sm text-gray-400 mb-3 block">Obfuscation Level</label>
                <div class="flex justify-center items-center gap-4 text-gray-300">
                    <label class="flex items-center">
                        <input type="radio" name="level" value="medium" class="mr-2 h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500" checked>
                        <span class="text-sm">Medium</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="level" value="high" class="mr-2 h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-sm">High</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="level" value="extreme" class="mr-2 h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 focus:ring-blue-500">
                        <span class="text-sm">Extreme</span>
                    </label>
                </div>
            </div>

            <button id="obfuscate-btn" class="btn-obfuscate text-white font-bold py-4 px-12 rounded-xl text-lg shadow-2xl">
                <span id="btn-text">üîí FORGE OBFUSCATION</span>
            </button>
        </footer>

        <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white py-3 px-6 rounded-lg shadow-2xl border border-blue-500 opacity-0 transform translate-y-5 transition-all duration-300">
            <div class="flex items-center gap-2">
                <span id="toast-icon">‚úì</span>
                <span id="toast-message">Operation completed!</span>
            </div>
        </div>
    </div>

    <script>
        class LuaObfuscator {
            constructor() {
                this.lua51Keywords = [
                    'and', 'break', 'do', 'else', 'elseif', 'end', 'false', 'for',
                    'function', 'if', 'in', 'local', 'nil', 'not', 'or', 'repeat',
                    'return', 'then', 'true', 'until', 'while'
                ];
            }

            minifyLua(code) {
                let result = code.replace(/--\[\[[\s\S]*?]]/g, '')
                                 .replace(/--.*$/gm, '')
                                 .replace(/\s+/g, ' ');
                return result.trim();
            }

            generateIdentifier(prefix = 'V') {
                const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_';
                let result = prefix;
                const length = Math.floor(Math.random() * 6) + 4;
                for (let i = 0; i < length; i++) {
                    result += chars[Math.floor(Math.random() * chars.length)];
                }
                return result;
            }

            obfuscate(code, level = 'medium') {
                const minified = this.minifyLua(code);
                const options = {
                    medium: { chunkSize: 40, iterations: 2 },
                    high: { chunkSize: 25, iterations: 3, polymorphic: true, antiDebug: true },
                    extreme: { chunkSize: 15, iterations: 5, polymorphic: true, antiDebug: true, multiLayer: true }
                };
                return this.createVMObfuscation(minified, options[level]);
            }

            encodeLayer(data, key) {
                let sourceData = (typeof data === 'string')
                    ? Array.from(data).map(char => char.charCodeAt(0))
                    : data;
                return sourceData.map(charCode => (charCode ^ key) & 0xFF);
            }

            createVMObfuscation(code, options) {
                const { chunkSize, iterations, polymorphic, antiDebug } = options;
                const constants = [], numberConstants = [], stringMap = new Map(), numberMap = new Map();

                let processedCode = code.replace(/"((?:\\"|[^"])*)"/g, (match, str) => {
                    if (!stringMap.has(str)) { stringMap.set(str, constants.length); constants.push(match); }
                    return `_S(${stringMap.get(str)})`;
                });
                processedCode = processedCode.replace(/\b(\d+(?:\.\d+)?)\b/g, (match, num) => {
                    if (!numberMap.has(num)) { numberMap.set(num, numberConstants.length); numberConstants.push(num); }
                    return `_N(${numberMap.get(num)})`;
                });

                const vmVars = {
                    constants: this.generateIdentifier('C'), numbers: this.generateIdentifier('N'),
                    key: this.generateIdentifier('K'), instructions: this.generateIdentifier('I'),
                    buffer: this.generateIdentifier('B'), decoder: this.generateIdentifier('D'),
                };

                let currentCode = processedCode;
                const keys = [];
                for (let iter = 0; iter < iterations; iter++) {
                    const key = Math.floor(Math.random() * 256); 
                    keys.push(key);
                    currentCode = this.encodeLayer(currentCode, key);
                }

                const chunks = [];
                for (let i = 0; i < currentCode.length; i += chunkSize) {
                    chunks.push({ data: currentCode.slice(i, i + chunkSize), originalIndex: chunks.length });
                }
                for (let i = chunks.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [chunks[i], chunks[j]] = [chunks[j], chunks[i]];
                }

                let vmCore = this.generateVMCore(vmVars, chunks, keys, constants, numberConstants);
                if (antiDebug) vmCore = this.addAntiDebug(vmCore);
                if (polymorphic) vmCore = this.addPolymorphicWrapper(vmCore);
                return this.addIntegrityProtection(vmCore);
            }
            
            generateVMCore(vmVars, chunks, keys, constants, numbers) {
                const consts = constants.length > 0 ? `{${constants.join(',')}}` : '{}';
                const nums = numbers.length > 0 ? `{${numbers.join(',')}}` : '{}';
                const keyT = `{${keys.join(',')}}`;
                const instT = chunks.map(c => `{${c.originalIndex},{${c.data.join(',')}}}`).join(',');
                const bitPolyfill = `local bit = _G.bit32 or (function() local b={}; function b.bxor(a,c) local r,p=0,1; while a>0 or c>0 do local ra,rc=a%2,c%2; if ra~=rc then r=r+p end; a,c,p=(a-ra)/2,(c-rc)/2,p*2 end; return r end; return b end)();`;

                return `(function() ${bitPolyfill} local ${vmVars.constants}=${consts}; local ${vmVars.numbers}=${nums}; local ${vmVars.key}=${keyT}; local ${vmVars.instructions}={${instT}}; local ${vmVars.buffer}={}; local function _S(i)return ${vmVars.constants}[i+1]end; local function _N(i)return tonumber(${vmVars.numbers}[i+1])end; local function ${vmVars.decoder}(data,dKeys) local res={}; for i=1,#data do local char=data[i]; for j=#dKeys,1,-1 do char=bit.bxor(char,dKeys[j])end; res[i]=string.char(char) end; return table.concat(res) end; for i=1,#${vmVars.instructions} do local inst=${vmVars.instructions}[i]; local pos=inst[1]+1; local data={}; for j=2,#inst do data[#data+1]=inst[j]end; ${vmVars.buffer}[pos]=${vmVars.decoder}(data[1],${vmVars.key}) end; local env=setmetatable({_S=_S,_N=_N},{__index=_G}); local chunk=loadstring(table.concat(${vmVars.buffer})); if chunk then setfenv(chunk,env);return chunk()end end)()`;
            }
            
            addPolymorphicWrapper(vmCore) {
                const key = Math.floor(Math.random() * 256); // Key must be a byte
                const data = Array.from(vmCore).map((c, i) => (c.charCodeAt(0) ^ (key + i % 256)) & 0xFF);
                const kVar = this.generateIdentifier('k'), dataVar = this.generateIdentifier('d'), resVar = this.generateIdentifier('r');
                const bitPolyfill = `local bit = _G.bit32 or (function() local b={}; function b.bxor(a,c) local r,p=0,1; while a>0 or c>0 do local ra,rc=a%2,c%2; if ra~=rc then r=r+p end; a,c,p=(a-ra)/2,(c-rc)/2,p*2 end; return r end; return b end)();`;

                return `(function() ${bitPolyfill} local ${kVar}=${key}; local ${dataVar}={${data.join(',')}}; local ${resVar}={}; for i=1,#${dataVar} do ${resVar}[i]=string.char(bit.bxor(${dataVar}[i], (${kVar}+(i-1))%256)) end; return loadstring(table.concat(${resVar}))() end)()`;
            }

            addAntiDebug(vmCore) {
                const adFunc = this.generateIdentifier('AD');
                const checks = `local function ${adFunc}() if debug and debug.getinfo and debug.getinfo(2,'S').what~='C' then return false end; return true end; if not ${adFunc}() then return end;`;
                return vmCore.replace('local env=', checks + 'local env=');
            }

            addIntegrityProtection(vmCore) {
                const check = this.generateIdentifier('C');
                const code = this.generateIdentifier('D');
                const sum = this.generateIdentifier('S');
                let checksum = 0;
                for(let i=0; i<vmCore.length; i++) { checksum = (checksum + vmCore.charCodeAt(i) * (i + 1)) % 65536; }
                const compressed = vmCore.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n');
                return `(function() local function ${check}(s) local h=0; for i=1,#s do h=(h+string.byte(s,i)*i)%65536 end; return h end; local ${code}="${compressed}"; local ${sum}=${checksum}; if ${check}(${code})~=${sum} then return; end; return loadstring(${code})() end)()`;
            }
        }

        class ObfuscatorUI {
            constructor() {
                this.obfuscator = new LuaObfuscator();
                this.isProcessing = false;
                this.initializeElements();
                this.bindEvents();
                this.elements.input.value = `function say_hello()\n    print("Hello, Obfuscated World!")\nend\n\nsay_hello()`;
            }

            initializeElements() {
                this.elements = {
                    input: document.getElementById('lua-input'),
                    output: document.getElementById('lua-output'),
                    obfuscateBtn: document.getElementById('obfuscate-btn'),
                    btnText: document.getElementById('btn-text'),
                    copyBtn: document.getElementById('copy-btn'),
                    analyzeBtn: document.getElementById('analyze-btn'),
                    toast: document.getElementById('toast'),
                    toastIcon: document.getElementById('toast-icon'),
                    toastMessage: document.getElementById('toast-message'),
                    outputStats: document.getElementById('output-stats'),
                    levelRadios: document.querySelectorAll('input[name="level"]')
                };
            }

            bindEvents() {
                this.elements.obfuscateBtn.addEventListener('click', () => this.handleObfuscate());
                this.elements.copyBtn.addEventListener('click', () => this.handleCopy());
            }

            getSelectedLevel() {
                return Array.from(this.elements.levelRadios).find(r => r.checked)?.value || 'medium';
            }

            async handleObfuscate() {
                if (this.isProcessing) return;
                const code = this.elements.input.value.trim();
                if (!code) return this.showToast('‚ö†Ô∏è', 'Please enter Lua code.', 'warning');

                this.setProcessingState(true);
                try {
                    await new Promise(res => setTimeout(res, 300));
                    const startTime = performance.now();
                    const obfuscatedCode = this.obfuscator.obfuscate(code, this.getSelectedLevel());
                    const time = Math.round(performance.now() - startTime);
                    
                    this.elements.output.value = obfuscatedCode;
                    this.updateOutputStats(code, obfuscatedCode, time);
                    this.showToast('‚úì', `Obfuscation complete in ${time}ms.`, 'success');
                } catch (error) {
                    console.error('Obfuscation error:', error);
                    this.elements.output.value = `-- Obfuscation Error --\n-- ${error.message}`;
                    this.showToast('‚ùå', 'An error occurred during obfuscation.', 'error');
                } finally {
                    this.setProcessingState(false);
                }
            }
            
            setProcessingState(isProcessing) {
                this.isProcessing = isProcessing;
                this.elements.obfuscateBtn.disabled = isProcessing;
                this.elements.btnText.textContent = isProcessing ? 'üîÑ PROCESSING...' : 'üîí FORGE OBFUSCATION';
                if(isProcessing) this.elements.obfuscateBtn.classList.add('processing');
                else this.elements.obfuscateBtn.classList.remove('processing');
            }

            handleCopy() {
                const output = this.elements.output.value;
                if (!output || output.includes('will appear here')) return this.showToast('‚ö†Ô∏è', 'Nothing to copy.', 'warning');
                navigator.clipboard.writeText(output)
                    .then(() => this.showToast('üìã', 'Copied to clipboard!', 'success'))
                    .catch(() => this.showToast('‚ùå', 'Could not copy to clipboard.', 'error'));
            }

            updateOutputStats(original, obfuscated, time) {
                if (original.length === 0) return;
                const ratio = ((obfuscated.length / original.length) * 100).toFixed(1);
                this.elements.outputStats.textContent = `${obfuscated.length} chars | ${ratio}% of original | ${time}ms`;
            }

            showToast(icon, message, type) {
                this.elements.toastIcon.textContent = icon;
                this.elements.toastMessage.textContent = message;
                const colors = {
                    success: 'border-green-500 bg-green-900/60',
                    error: 'border-red-500 bg-red-900/60',
                    warning: 'border-yellow-500 bg-yellow-900/60',
                    info: 'border-blue-500 bg-blue-900/60'
                };
                this.elements.toast.className = `fixed bottom-6 right-6 text-white py-3 px-6 rounded-lg shadow-2xl backdrop-blur-sm ${colors[type]} opacity-100 transform translate-y-0 transition-all duration-300`;
                setTimeout(() => {
                    this.elements.toast.className = this.elements.toast.className.replace('opacity-100 translate-y-0', 'opacity-0 translate-y-5');
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => new ObfuscatorUI());
    </script>
</body>
</html>
