<!DOCTYPE html>
<html>
<head>
    <title>Advanced Lua 5.1 Obfuscator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #ffffff;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.8;
            font-size: 1.1em;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .input-section, .output-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #4ecdc4;
            font-weight: 600;
        }
        textarea {
            width: 100%;
            height: 400px;
            background: rgba(0, 0, 0, 0.3);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            line-height: 1.5;
        }
        textarea:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
        }
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .controls {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .option-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .option-card:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .option-card.active {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        .option-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .option-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            accent-color: #4ecdc4;
        }
        .option-title {
            font-weight: 600;
            color: #ffffff;
        }
        .option-description {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .status.success {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        .status.processing {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ecdc4;
        }
        .stat-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .options-grid {
                grid-template-columns: 1fr;
            }
            .button-container {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Advanced Lua 5.1 Obfuscator</h1>
            <p>Military-grade obfuscation with custom VM, dynamic decryption, and anti-analysis protection</p>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <div class="section-title">Input Lua Code</div>
                <textarea id="input-lua" placeholder="-- Paste your Lua 5.1 code here
print('Hello World!')
local x = 10
local y = 20
print('Result: ' .. (x + y))

-- Your code will be transformed into an unrecognizable,
-- highly protected form using advanced obfuscation techniques"></textarea>
            </div>
            
            <div class="output-section">
                <div class="section-title">Obfuscated Output</div>
                <textarea id="output-lua" readonly placeholder="Your obfuscated Lua code will appear here...

The output will include:
‚Ä¢ Custom VM with polymorphic opcodes
‚Ä¢ Dynamic string encryption
‚Ä¢ Anti-debugging protection
‚Ä¢ Control flow obfuscation
‚Ä¢ Variable name mangling
‚Ä¢ Polymorphic execution layers"></textarea>
            </div>
        </div>
        
        <div class="controls">
            <div class="section-title">Obfuscation Options</div>
            <div class="options-grid">
                <div class="option-card active" data-option="vm_obfuscation">
                    <div class="option-header">
                        <input type="checkbox" class="option-checkbox" id="vm-obfuscation" checked>
                        <div class="option-title">Custom VM Obfuscation</div>
                    </div>
                    <div class="option-description">Transforms code into custom VM instructions with polymorphic opcodes</div>
                </div>
                
                <div class="option-card active" data-option="string_encryption">
                    <div class="option-header">
                        <input type="checkbox" class="option-checkbox" id="string-encryption" checked>
                        <div class="option-title">Dynamic String Encryption</div>
                    </div>
                    <div class="option-description">Encrypts all strings with rotating keys and polymorphic decryption</div>
                </div>
                
                <div class="option-card active" data-option="control_flow">
                    <div class="option-header">
                        <input type="checkbox" class="option-checkbox" id="control-flow" checked>
                        <div class="option-title">Control Flow Obfuscation</div>
                    </div>
                    <div class="option-description">Adds complex conditional logic and dead code paths</div>
                </div>
                
                <div class="option-card active" data-option="anti_debug">
                    <div class="option-header">
                        <input type="checkbox" class="option-checkbox" id="anti-debug" checked>
                        <div class="option-title">Anti-Debug Protection</div>
                    </div>
                    <div class="option-description">Multiple layers of debugger detection and environment validation</div>
                </div>
                
                <div class="option-card active" data-option="variable_mangling">
                    <div class="option-header">
                        <input type="checkbox" class="option-checkbox" id="variable-mangling" checked>
                        <div class="option-title">Variable Name Mangling</div>
                    </div>
                    <div class="option-description">Randomizes all variable and function names</div>
                </div>
                
                <div class="option-card" data-option="polymorphic">
                    <div class="option-header">
                        <input type="checkbox" class="option-checkbox" id="polymorphic">
                        <div class="option-title">Polymorphic Layer</div>
                    </div>
                    <div class="option-description">Additional encryption layer that changes with each execution</div>
                </div>
            </div>
            
            <div class="button-container">
                <button class="btn btn-primary" id="obfuscate-btn" onclick="obfuscateLua()">
                    üîí Obfuscate Code
                </button>
                <button class="btn btn-secondary" id="copy-btn" onclick="copyOutput()" disabled>
                    üìã Copy Output
                </button>
                <button class="btn btn-secondary" id="clear-btn" onclick="clearAll()">
                    üóëÔ∏è Clear All
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your Lua code with advanced obfuscation techniques...</p>
            </div>
            
            <div class="status" id="status"></div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="original-size">0</div>
                    <div class="stat-label">Original Size (chars)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="obfuscated-size">0</div>
                    <div class="stat-label">Obfuscated Size (chars)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="complexity-ratio">0x</div>
                    <div class="stat-label">Complexity Increase</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="protection-level">Military</div>
                    <div class="stat-label">Protection Level</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdvancedLuaObfuscator {
            constructor() {
                this.varMap = new Map();
                this.encryptionKeys = Array.from({length: 32}, () => Math.floor(Math.random() * 255) + 1);
                this.vmOpcodes = this.generatePolymorphicOpcodes();
                this.antiDebugSignatures = this.generateAntiDebugSignatures();
            }

            generatePolymorphicOpcodes() {
                const opcodes = {};
                const baseOps = [
                    'ADD', 'SUB', 'MUL', 'DIV', 'MOD', 'POW', 'UNM', 'NOT', 'LEN', 
                    'CONCAT', 'EQ', 'LT', 'LE', 'CALL', 'JMP', 'RET', 'LOADK', 'LOADBOOL', 
                    'LOADNIL', 'GETUPVAL', 'SETUPVAL', 'GETGLOBAL', 'SETGLOBAL', 
                    'NEWTABLE', 'SETTABLE', 'GETTABLE', 'SELF', 'FORPREP', 'FORLOOP', 
                    'TFORLOOP', 'SETLIST', 'CLOSE', 'CLOSURE', 'VARARG'
                ];
                const shuffled = [...baseOps].sort(() => Math.random() - 0.5);
                shuffled.forEach((op, i) => {
                    opcodes[op] = Math.floor(Math.random() * 255) + 1;
                });
                return opcodes;
            }

            generateAntiDebugSignatures() {
                const signatures = [
                    "debug.getinfo(1, 'S').what == 'C'",
                    "os.clock() - _AD_START_TIME > 0.1",
                    "_G.collectgarbage == nil",
                    "_G.print == nil",
                    "string.find(debug.traceback(), 'hook')",
                    "getfenv(0) ~= _G",
                    "table.getn({}) ~= 0",
                    "math.sin(0) ~= 0",
                    "string.byte('A') ~= 65"
                ];
                return signatures.sort(() => Math.random() - 0.5);
            }

            generateRandomName(length = 12) {
                const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            lua51BitwiseXor(a, b) {
                let result = 0;
                let power = 1;
                while (a > 0 || b > 0) {
                    const bitA = a % 2;
                    const bitB = b % 2;
                    if (bitA !== bitB) {
                        result += power;
                    }
                    a = Math.floor(a / 2);
                    b = Math.floor(b / 2);
                    power *= 2;
                }
                return result;
            }

            polymorphicEncrypt(data, keyIndex = 0) {
                const key = this.encryptionKeys[keyIndex % this.encryptionKeys.length];
                let result = '';
                for (let i = 0; i < data.length; i++) {
                    const xorResult = this.lua51BitwiseXor(data.charCodeAt(i), (key + i) % 256);
                    result += String.fromCharCode(xorResult);
                }
                return btoa(result);
            }

            obfuscateStrings(code) {
                const strings = [];
                const stringRegex = /"([^"\\\\]|\\\\.)*"|'([^'\\\\]|\\\\.)*'/g;
                
                const obfuscatedCode = code.replace(stringRegex, (match) => {
                    const content = match.slice(1, -1);
                    const keyIndex = Math.floor(Math.random() * this.encryptionKeys.length);
                    const encrypted = this.polymorphicEncrypt(content, keyIndex);
                    const index = strings.length;
                    strings.push({ encrypted, keyIndex });
                    return `_STR[${index}]`;
                });
                
                return { obfuscatedCode, strings };
            }

            obfuscateVariables(code) {
                const luaKeywords = new Set([
                    'and', 'break', 'do', 'else', 'elseif', 'end', 'false', 'for',
                    'function', 'if', 'in', 'local', 'nil', 'not', 'or', 'repeat',
                    'return', 'then', 'true', 'until', 'while', 'print', 'type',
                    'tostring', 'tonumber', 'pairs', 'ipairs', 'next', 'getmetatable',
                    'setmetatable', 'rawget', 'rawset', 'string', 'table', 'math',
                    'io', 'os', 'debug', 'coroutine', 'package', 'require', 'loadstring',
                    'assert', 'error', 'pcall', 'xpcall', 'select', 'unpack', 'rawlen', 'rawequal'
                ]);
                
                const varRegex = /\b[a-zA-Z_][a-zA-Z0-9_]*\b/g;
                
                return code.replace(varRegex, (match) => {
                    if (luaKeywords.has(match)) {
                        return match;
                    }
                    if (!this.varMap.has(match)) {
                        this.varMap.set(match, this.generateRandomName());
                    }
                    return this.varMap.get(match);
                });
            }

            createCustomVMDispatcher(code, strings) {
                const vmKey = Math.floor(Math.random() * 9000) + 1000;
                
                let stringDeclarations = '';
                strings.forEach((str, index) => {
                    stringDeclarations += `    _STR[${index}] = _VM_RUNTIME.decrypt("${str.encrypted}", _KEYS[${str.keyIndex + 1}])\\n`;
                });
                
                const vmInstructionsRaw = this.parseCodeToInstructions(code);
                const obfuscatedVmInstructions = vmInstructionsRaw.map(instr => {
                    const keyIdx = Math.floor(Math.random() * this.encryptionKeys.length);
                    return this.polymorphicEncrypt(instr, keyIdx);
                });
                
                const dispatcherCases = this.generateDispatcherCases(obfuscatedVmInstructions);
                
                return `local _VM_RUNTIME = {}
local _STR = {}
local _KEYS = {${this.encryptionKeys.join(', ')}}
local _VM_INSTRUCTIONS = {${obfuscatedVmInstructions.map(b64 => `"${b64}"`).join(', ')}}
local _OPCODES = {${Object.entries(this.vmOpcodes).map(([k, v]) => `[${v}] = "${k}"`).join(', ')}}

function _VM_RUNTIME.xor(a, b)
    local result = 0
    local power = 1
    while a > 0 or b > 0 do
        local bitA = a % 2
        local bitB = b % 2
        if bitA ~= bitB then
            result = result + power
        end
        a = math.floor(a / 2)
        b = math.floor(b / 2)
        power = power * 2
    end
    return result
end

function _VM_RUNTIME.base64_decode(data, key)
    local decoded = ""
    local b64chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
    
    data = data:gsub('[^'..b64chars..'=]', '')
    if #data % 4 ~= 0 then
        data = data .. string.rep('=', 4 - (#data % 4))
    end
    
    for i = 1, #data, 4 do
        local a, b, c, d = data:byte(i, i+3)
        if not a or not b then break end
        
        local char_a = string.char(a)
        local char_b = string.char(b)
        local char_c = c and string.char(c) or '='
        local char_d = d and string.char(d) or '='
        
        local pos_a = b64chars:find(char_a)
        local pos_b = b64chars:find(char_b)
        local pos_c = char_c ~= '=' and b64chars:find(char_c) or 65
        local pos_d = char_d ~= '=' and b64chars:find(char_d) or 65
        
        if not pos_a or not pos_b then
            error("Invalid Base64 character at position " .. i)
        end
        
        pos_a = pos_a - 1
        pos_b = pos_b - 1
        pos_c = pos_c and (pos_c - 1) or 64
        pos_d = pos_d and (pos_d - 1) or 64
        
        local n = pos_a * 262144 + pos_b * 4096 + pos_c * 64 + pos_d
        decoded = decoded .. string.char(math.floor(n / 65536))
        if pos_c ~= 64 then decoded = decoded .. string.char(math.floor(n / 256) % 256) end
        if pos_d ~= 64 then decoded = decoded .. string.char(n % 256) end
    end
    
    local result = ""
    for i = 1, #decoded do
        local byte = string.byte(decoded, i)
        result = result .. string.char(_VM_RUNTIME.xor(byte, (key + i - 1) % 256))
    end
    
    return result
end

function _VM_RUNTIME.decrypt(data, key)
    return _VM_RUNTIME.base64_decode(data, key)
end

function _VM_RUNTIME.execute_instruction(instruction_id)
    local instruction_key_index = instruction_id % ${this.encryptionKeys.length}
    local instruction_data = _VM_INSTRUCTIONS[instruction_id + 1]
    local instruction_key = _KEYS[instruction_key_index + 1]
    local decrypted_instruction = _VM_RUNTIME.decrypt(instruction_data, instruction_key)
    
    local parts = {}
    for part in string.gmatch(decrypted_instruction, "[^ ]+") do
        table.insert(parts, part)
    end
    local opcode = parts[1]
    
${dispatcherCases}
end

function _VM_RUNTIME.run()
${stringDeclarations}    for i = 0, ${obfuscatedVmInstructions.length} - 1 do
        _VM_RUNTIME.execute_instruction(i)
    end
end

_VM_RUNTIME.run()`;
            }

            parseCodeToInstructions(code) {
                const instructions = [];
                const lines = code.split('\\n');
                
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed.startsWith('--')) continue;
                    
                    if (trimmed.startsWith('print(')) {
                        const match = trimmed.match(/print\\((.*)\\)/);
                        if (match) {
                            const content = match[1];
                            if (content.startsWith('_STR[') && content.endsWith(']')) {
                                try {
                                    const idx = parseInt(content.slice(5, -1));
                                    instructions.push(`PRINT_STR ${idx}`);
                                } catch {
                                    instructions.push(`PRINT_RAW ${content}`);
                                }
                            } else {
                                instructions.push(`PRINT_RAW ${content}`);
                            }
                        }
                    } else if (trimmed.startsWith('local ')) {
                        const match = trimmed.match(/local\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*(.*)/);
                        if (match) {
                            instructions.push(`SET_VAR ${match[1]} ${match[2]}`);
                        }
                    } else if (trimmed.includes(' = ') && !trimmed.startsWith('local ')) {
                        const match = trimmed.match(/([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*(.*)/);
                        if (match) {
                            instructions.push(`SET_VAR ${match[1]} ${match[2]}`);
                        }
                    } else {
                        instructions.push(`EXEC_RAW ${trimmed}`);
                    }
                }
                
                return instructions;
            }

            generateDispatcherCases(instructions) {
                const cases = [];
                instructions.forEach((_, i) => {
                    const keyIdx = Math.floor(Math.random() * this.encryptionKeys.length);
                    cases.push(`    if instruction_id == ${i} then
        if opcode == "PRINT_STR" then
            print(_STR[tonumber(parts[2])])
        elseif opcode == "PRINT_RAW" then
            local raw_expr = string.sub(decrypted_instruction, 11)
            local func = loadstring("return " .. raw_expr)
            if func then
                print(func())
            else
                print(raw_expr)
            end
        elseif opcode == "SET_VAR" then
            _G[parts[2]] = loadstring("return " .. parts[3])()
        elseif opcode == "EXEC_RAW" then
            local raw_code = string.sub(decrypted_instruction, 10)
            loadstring(raw_code)()
        end
    end`);
                });
                return cases.join('\\n');
            }

            addControlFlowObfuscation(code) {
                const predicates = [
                    'math.random() > 0.5',
                    'os.time() % 2 == 0', 
                    'string.len("test") == 4',
                    'type(nil) == "nil"',
                    'math.floor(3.7) == 3',
                    'string.sub("hello", 1, 1) == "h"'
                ];
                
                const randomPredicate = predicates[Math.floor(Math.random() * predicates.length)];
                const dummyOperations = [
                    'local _ = math.sin(0)',
                    'local _ = string.len("")', 
                    'local _ = type({})',
                    'local _ = os.time() % 1000'
                ];
                
                const dummyOp = dummyOperations[Math.floor(Math.random() * dummyOperations.length)];
                
                return `local _CF_GUARD = {}
_CF_GUARD.check1 = function() return ${randomPredicate} end
_CF_GUARD.check2 = function() ${dummyOp}; return not ${randomPredicate} end

local function _EXEC_FLOW()
    if _CF_GUARD.check1() or _CF_GUARD.check2() then
        local _path = math.random(1, 10)
        if _path > 5 and _CF_GUARD.check1() then
${code}
        else
            local _dummy_var = 12345
            if _dummy_var == 0 then
                print("This should never execute")
            end
        end
    else
        error("Control flow bypass detected")
    end
end

_EXEC_FLOW()`;
            }

            addAntiDebugProtection(code) {
                const newline = '\\n';
                const checks = this.antiDebugSignatures.map(sig => 
                    `    if not (${sig}) then error("Anti-debug check failed") end`
                );
                
                return `local _AD_START_TIME = os.clock()
local _AD_CHECKS = {}

_AD_CHECKS.run = function()
${checks.join(newline)}
    return true
end

if _AD_CHECKS.run() then
${code}
else
    error("Debugger or tampering detected")
end`;
            }

            addPolymorphicLayer(code) {
                const polyKeyIndex = Math.floor(Math.random() * this.encryptionKeys.length);
                const encrypted = this.polymorphicEncrypt(code, polyKeyIndex);
                
                return `local _POLY_LAYER = {}
_POLY_LAYER.key_idx = ${polyKeyIndex}
_POLY_LAYER.data = "${encrypted}"
_POLY_LAYER.keys = {${this.encryptionKeys.join(', ')}}

function _POLY_LAYER.xor(a, b)
    local result = 0
    local power = 1
    while a > 0 or b > 0 do
        local bitA = a % 2
        local bitB = b % 2
        if bitA ~= bitB then
            result = result + power
        end
        a = math.floor(a / 2)
        b = math.floor(b / 2)
        power = power * 2
    end
    return result
end

function _POLY_LAYER.base64_decode_safe(data, key)
    local decoded = ""
    local b64chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
    
    data = data:gsub('[^'..b64chars..'=]', '')
    if #data % 4 ~= 0 then
        data = data .. string.rep('=', 4 - (#data % 4))
    end
    
    for i = 1, #data, 4 do
        local a, b, c, d = data:byte(i, i+3)
        if not a or not b then break end
        
        local char_a = string.char(a)
        local char_b = string.char(b)
        local char_c = c and string.char(c) or '='
        local char_d = d and string.char(d) or '='
        
        local pos_a = b64chars:find(char_a)
        local pos_b = b64chars:find(char_b)
        local pos_c = char_c ~= '=' and b64chars:find(char_c) or nil
        local pos_d = char_d ~= '=' and b64chars:find(char_d) or nil
        
        if not pos_a or not pos_b then
            error("Invalid Base64 character: " .. char_a .. " or " .. char_b .. " at position " .. i)
        end
        
        pos_a = pos_a - 1
        pos_b = pos_b - 1
        pos_c = pos_c and (pos_c - 1) or 64
        pos_d = pos_d and (pos_d - 1) or 64
        
        local n = pos_a * 262144 + pos_b * 4096 + pos_c * 64 + pos_d
        decoded = decoded .. string.char(math.floor(n / 65536))
        if pos_c ~= 64 then decoded = decoded .. string.char(math.floor(n / 256) % 256) end
        if pos_d ~= 64 then decoded = decoded .. string.char(n % 256) end
    end
    
    local result = ""
    for i = 1, #decoded do
        local byte = string.byte(decoded, i)
        result = result .. string.char(_POLY_LAYER.xor(byte, (key + i - 1) % 256))
    end
    
    return result
end

function _POLY_LAYER.decrypt_and_execute()
    local key = _POLY_LAYER.keys[_POLY_LAYER.key_idx + 1]
    local result = _POLY_LAYER.base64_decode_safe(_POLY_LAYER.data, key)
    
    local success, err = pcall(function() loadstring(result)() end)
    if not success then
        error("Polymorphic layer execution failed: " .. tostring(err))
    end
end

_POLY_LAYER.decrypt_and_execute()`;
            }

            obfuscateCode(code, options) {
                this.varMap = new Map();
                this.encryptionKeys = Array.from({length: 32}, () => Math.floor(Math.random() * 255) + 1);
                this.vmOpcodes = this.generatePolymorphicOpcodes();
                this.antiDebugSignatures = this.generateAntiDebugSignatures();

                let obfuscated = code;
                let strings = [];
                
                if (options.variableMangling) {
                    obfuscated = this.obfuscateVariables(obfuscated);
                }
                
                if (options.stringEncryption) {
                    const result = this.obfuscateStrings(obfuscated);
                    obfuscated = result.obfuscatedCode;
                    strings = result.strings;
                }
                
                if (options.controlFlow) {
                    obfuscated = this.addControlFlowObfuscation(obfuscated);
                }
                
                if (options.antiDebug) {
                    obfuscated = this.addAntiDebugProtection(obfuscated);
                }
                
                obfuscated = this.createCustomVMDispatcher(obfuscated, strings);
                
                if (options.polymorphic) {
                    obfuscated = this.addPolymorphicLayer(obfuscated);
                }
                
                return obfuscated;
            }
        }

        const obfuscator = new AdvancedLuaObfuscator();

        document.querySelectorAll('.option-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const card = this.closest('.option-card');
                if (this.checked) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
        });

        function obfuscateLua() {
            const inputCode = document.getElementById('input-lua').value.trim();
            const status = document.getElementById('status');
            const outputTextarea = document.getElementById('output-lua');
            const obfuscateBtn = document.getElementById('obfuscate-btn');
            const copyBtn = document.getElementById('copy-btn');
            const loading = document.getElementById('loading');
            const stats = document.getElementById('stats');
            
            if (!inputCode) {
                status.textContent = 'Please enter some Lua code to obfuscate.';
                status.className = 'status error';
                return;
            }
            
            obfuscateBtn.disabled = true;
            loading.style.display = 'block';
            status.textContent = '';
            status.className = 'status';
            stats.style.display = 'none';
            
            setTimeout(() => {
                try {
                    const options = {
                        vmObfuscation: document.getElementById('vm-obfuscation').checked,
                        stringEncryption: document.getElementById('string-encryption').checked,
                        controlFlow: document.getElementById('control-flow').checked,
                        antiDebug: document.getElementById('anti-debug').checked,
                        variableMangling: document.getElementById('variable-mangling').checked,
                        polymorphic: document.getElementById('polymorphic').checked
                    };
                    
                    const obfuscatedCode = obfuscator.obfuscateCode(inputCode, options);
                    
                    outputTextarea.value = obfuscatedCode;
                    copyBtn.disabled = false;
                    status.textContent = 'Code obfuscated successfully with military-grade protection!';
                    status.className = 'status success';
                    
                    document.getElementById('original-size').textContent = inputCode.length.toLocaleString();
                    document.getElementById('obfuscated-size').textContent = obfuscatedCode.length.toLocaleString();
                    document.getElementById('complexity-ratio').textContent = Math.round(obfuscatedCode.length / inputCode.length) + 'x';
                    
                    stats.style.display = 'grid';
                    
                } catch (error) {
                    status.textContent = 'Error during obfuscation: ' + error.message;
                    status.className = 'status error';
                } finally {
                    obfuscateBtn.disabled = false;
                    loading.style.display = 'none';
                }
            }, 500);
        }

        function copyOutput() {
            const outputTextarea = document.getElementById('output-lua');
            const status = document.getElementById('status');
            
            outputTextarea.select();
            outputTextarea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                status.textContent = 'Obfuscated code copied to clipboard!';
                status.className = 'status success';
            } catch (error) {
                status.textContent = 'Failed to copy to clipboard.';
                status.className = 'status error';
            }
        }

        function clearAll() {
            document.getElementById('input-lua').value = '';
            document.getElementById('output-lua').value = '';
            document.getElementById('copy-btn').disabled = true;
            document.getElementById('status').textContent = '';
            document.getElementById('status').className = 'status';
            document.getElementById('stats').style.display = 'none';
        }

        document.getElementById('input-lua').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                obfuscateLua();
            }
        });
    </script>
</body>
</html>

